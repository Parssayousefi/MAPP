---
title: "MAPP"
author: "Parsa Yousefi"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

if (!require("lavaan")) {
    install.packages("lavaan")
}

library(lavaan)
library(readxl)
library(ggplot2)


```

#CFA

Load Data
```{r}
data <- read_excel()
#test data from lavaan


data <- HolzingerSwineford1939
data$school <- NULL
head(data)

```

#Preprocessing
```{r}
#sampel size estimate

#testing assumptions


# - Handling missing values
        #Full Information Maximum Likelihood
        #Multiple Imputation
# - Variable transformations
# - Normalization procedures (if applicable)

# Descriptive statistics, normality checks, etc.

# standardized residuals

#check each items if they are continious. 

```


#CFA
```{r}

# Define the CFA model
# assuming first columsn is ID
# we have 250 items
item_names <- colnames(data)[-1]
factor_name <- "Mystic"
model_items <- paste(factor_name, "=~", paste(item_names, collapse = " + "))

# Define the CFA model
model <- model_items

# check if the model is correctly dfefined
#pathdiageam: samplot -> sampaths
#Assumption checks
# Tests for multivariate normality, multicollinearity, etc.

# Fit the model & Summarize the results
fit <- cfa(model, data = data, orthogonal = FALSE, estimator = "ML")

#look at model loadings
summary(fit, fit.measures = TRUE, standardized = TRUE)

# Model Evaluation: which indices to be reported? CFI, chi^2,sRMR, RMSEA, AIC.?

#eqeuivalence test
?cov2cor
# standardized residuals
std_residuals <- lavResiduals(fit, type = "standardized")
head(std_residuals)
# heat map of residuals indicate the magnitude and direction of the residuals, 
# red indicating positive residuals, blue indicating negative residuals, and white indicating residuals close to zero.
ggplot(residuals_df, aes(x = Row, y = Column, fill = Residual)) +
    geom_tile() +
    scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0, limit = c(-3, 3)) +
    theme_minimal() +
    labs(title = "Standardized Residuals", x = "Item 1", y = "Item 2", fill = "Residual")

# histogram of residuals
ggplot(data.frame(Residual = residual_values), aes(x = Residual)) +
    geom_histogram(bins = 30, fill = "blue", color = "black") +
    theme_minimal() +
    labs(title = "Histogram of Standardized Residuals", x = "Standardized Residual", y = "Frequency")

 #Plot Q-Q Plot of Residuals
qqnorm(residual_values, main = "Q-Q Plot of Standardized Residuals")
qqline(residual_values, col = "red")


#modification indices
modeindices(fit, sort= TRUE)

```


#Hierarchical Laten Variable Modeling
```{r}
# Higher-order model specification
model_hierarchical <- '
  FOLV1 =~ item1 + item2 + item3
  FOLV2 =~ item4 + item5 + item6
  Mystic =~ FOLV1 + FOLV2
'
fit_hierarchical <- cfa(model_hierarchical, data = data, estimator = "ML")
summary(fit_hierarchical, fit.measures = TRUE, standardized = TRUE)


```
#sum scores
```{r}

# fit sum scores 


```
#Sensitivity Analyses
```{r}
# Sensitivity analyses
# repeating using different methods or subsets of data?
```

#Contingency Plans
```{r}
#What if the initial model doesnt fit?


```