---
title: "MAPP"
author: "Parsa Yousefi"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

if (!require("lavaan")) {
    install.packages("lavaan")
}
if (!require("pwr")) {
    install.packages("pwr")
}
if (!require("readxl")) {
    install.packages("readxl")
}
if (!require("ggplot2")) {
    install.packages("ggplot2")
}


library(lavaan)
library(readxl)
library(ggplot2)
library(pwr)


```
#Sample Size Planning
```{r}
```



#CFA

Load Data
```{r}
data <- read_excel()
#test data from lavaan


data <- HolzingerSwineford1939
data$school <- NULL
head(data)

```

#Preprocessing
```{r}
#sampel size estimate

#testing assumptions


# - Handling missing values
        #Full Information Maximum Likelihood
        #Multiple Imputation
# - Variable transformations
# - Normalization procedures (if applicable)

# Descriptive statistics, normality checks, etc.

# standardized residuals

#check each items if they are continious. 

```


#CFA
```{r}
# assume data has one clumn for each item: MEQ1, MEQ2, ..., CEQ1, CEQ2, ..., AWE1, AWE2,
# and so on. The first column is the ID column, so we start at the second column (index 2)

# Constructing the model string
# Here we concatenate 'Mystic =~' with all item names, joined by ' + '
modelString <- paste("Mystic =~", paste(names(data)[2:251], collapse=" + "))

# Print the model string to check it
# cat(modelString)

# Fit the model
fit <- cfa(modelString, data = data, estimator = "ML")

# Summarize the fit
summary(fit, fit.measures = TRUE, standardized = TRUE)
```

#check residuals
```{r}

# standardized residuals
std_residuals <- lavResiduals(fit, type = "standardized")
head(std_residuals)
# heat map of residuals indicate the magnitude and direction of the residuals, 
# red indicating positive residuals, blue indicating negative residuals, and white indicating residuals close to zero.
ggplot(residuals_df, aes(x = Row, y = Column, fill = Residual)) +
    geom_tile() +
    scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0, limit = c(-3, 3)) +
    theme_minimal() +
    labs(title = "Standardized Residuals", x = "Item 1", y = "Item 2", fill = "Residual")

# histogram of residuals
ggplot(data.frame(Residual = residual_values), aes(x = Residual)) +
    geom_histogram(bins = 30, fill = "blue", color = "black") +
    theme_minimal() +
    labs(title = "Histogram of Standardized Residuals", x = "Standardized Residual", y = "Frequency")

 #Plot Q-Q Plot of Residuals
qqnorm(residual_values, main = "Q-Q Plot of Standardized Residuals")
qqline(residual_values, col = "red")


#modification indices
modeindices(fit, sort= TRUE)

```


#Hierarchical Model
```{r}


# Higher-order model specification 
model_hierarchical <- '
  # Specific factors for each questionnaire
  MEQ =~ MEQ1 + MEQ2 + ... + MEQ30
  CEQ =~ CEQ1 + CEQ2 + ... + CEQ26
  AWES =~ AWES1 + AWES2 + ... + AWES30
  ESAT =~ ESAT1 + ESAT2 + ... + ESAT18
  EDI =~ EDI1 + EDI2 + ... + EDI8
  SWLS =~ SWLS1 + SWLS2 + ... + SWLS5
  NADA_S =~ NADA_S1 + NADA_S2 + NADA_S3
  ASC11D =~ ASC11D1 + ASC11D2 + ... + ASC11D11
  ASC11DShort =~ ASC11DShort1
  EISI =~ EISI1 + EISI2 + ... + EISI25
  INOE =~ INOE1 + INOE2 + ... + INOE_lastItem
  APEQ_S =~ APEQ_S1 + APEQ_S2 + ... + APEQ_S12
  LAP =~ LAP1 + LAP2 + ... + LAP56
  APEI =~ APEI1 + APEI2 + ... + APEI_lastItem

  # General factor "Mystic" influencing all specific factors
  Mystic =~ MEQ + CEQ + AWES + ESAT + EDI + SWLS + NADA_S + ASC11D + ASC11DShort + INOE + EISI + APEQ_S + LAP + APEI
'

# Fit the hierarchical model 
fit_hierarchical <- cfa(model_hierarchical, data = data, estimator = "ML")

# Summarize the model fit and interpret the results
summary(fit_hierarchical, fit.measures = TRUE, standardized = TRUE)


```

#bi-factor Model
```{r}
# Bi-factor model specification
model_bifactor <- '
    # Specific factors for each questionnaire
  MEQ =~ MEQ1 + MEQ2 + ... 
  CEQ =~ a*CEQ1 + a*CEQ2 + ... 
  AWES =~ b*AWES1 + b*AWES2 + ...
  ESAT =~ c*ESAT1 + c*ESAT2 + ... 
  EDI =~ d* DI1 + d*EDI2 + ... 
  SWLS =~ e*SWLS1 + e*SWLS2 + ... 
  NADA =~ f*NADA1 + f*NADA2 + ... 
  ASC11D =~ g*ASC11D1 + g*ASC11D2 + ... 
  ASC11DShort =~ h*ASC11DShort1 
  EISI =~ i*EISI1 + i*EISI2 + ... 
  INOE =~ j*INOE1 + j*INOE2 + ... 
  APEQS =~ k*APEQS1 + k*APEQS2 + ... 
  LAP =~ l*LAP1 + l*LAP2 + ... 
  APEI =~ m*APEI1 + m*APEI2 + ... 
  

 # General factor "mystic" affecting all items
  #Mystic =~ MEQ1 + MEQ2 + ... + APEI_lastItem
  paste("Mystic =~", paste(names(data)[2:251], collapse=" + "))

'

# Fit the bi-factor model
# orthogonal = TRUE makes all exogenous LVs in the model uncorrelated
#because we constrained the loadings for the domain-specific LVs with only two indicator 
#If we do not use this argument, then all the constrained factor loadings are set to 1 
fit_bifactor <- cfa(model_bifactor, data = data, orthogonal = TRUE, std.lv=TRUE, estimator = "ML")

# Summarize the model fit and interpret the results
summary(fit_bifactor, fit.measures = TRUE, standardized = TRUE)
```	

# Compare the bi-factor model to the hierarchical model
```{r}

```

#sum scores
```{r}

# fit sum scores 


```
#Sensitivity Analyses
```{r}
# Sensitivity analyses
# repeat with different methods or subsets of data?
```

#Contingency Plans
```{r}
#What if the initial model doesnt fit?


```

# What is the best predictor of well being?
```{r}


```
